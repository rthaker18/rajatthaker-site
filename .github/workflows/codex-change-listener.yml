name: Codex Change Executor

on:
  repository_dispatch:
    types: [codex_change_requested]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  codex_fix_and_pr:
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
      ISSUE_URL: ${{ github.event.client_payload.issue_url }}
      ISSUE_TITLE: ${{ github.event.client_payload.issue_title }}
      REQUEST_TEXT: ${{ github.event.client_payload.request }}
      REQUESTED_BY: ${{ github.event.client_payload.requested_by }}
      REQUEST_SOURCE: ${{ github.event.client_payload.source }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (auto-detect)
        run: |
          if [ ! -f package.json ]; then
            echo "No package.json found; skipping dependency install."
            exit 0
          fi

          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          elif [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Create working branch
        run: |
          issue_part="${ISSUE_NUMBER:-manual}"
          branch="codex/issue-${issue_part}-run-${GITHUB_RUN_ID}"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"
        id: branch

      - name: Build Codex prompt
        run: |
          cat > codex-request.md <<PROMPT
          You are Codex working inside a Git repository.

          Goal:
          - Implement the requested change from this GitHub issue request.

          Request metadata:
          - Source: ${REQUEST_SOURCE}
          - Requested by: ${REQUESTED_BY}
          - Issue: #${ISSUE_NUMBER}
          - Issue URL: ${ISSUE_URL}
          - Issue title: ${ISSUE_TITLE}

          Requested change:
          ${REQUEST_TEXT}

          Execution requirements:
          1) Make the smallest safe change that satisfies the request.
          2) Run relevant checks and ensure they pass when possible.
          3) Do not commit secrets.
          4) Do not push directly to main.
          5) Leave repository in a clean state with only intended changes.
          PROMPT

      - name: Validate OpenAI credentials
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY is not configured. Add it in Settings -> Secrets and variables -> Actions."
            exit 1
          fi

          if ! printf '%s' "$OPENAI_API_KEY" | grep -qE '^sk-'; then
            echo "OPENAI_API_KEY does not appear to be a valid OpenAI key (expected to start with sk-)."
            exit 1
          fi

          status=$(curl -sS -o /tmp/openai-models-check.json -w '%{http_code}' \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            https://api.openai.com/v1/models)

          if [ "$status" -ne 200 ]; then
            echo "OpenAI credential preflight failed with status $status"
            cat /tmp/openai-models-check.json || true
            exit 1
          fi

      - name: Run Codex to implement request
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          npm install -g @openai/codex

          git checkout -b "${{ steps.branch.outputs.branch }}"

          # Keep auth source unambiguous for Codex CLI.
          unset OPENAI_TOKEN OPENAI_KEY OPENAI_AUTH_TOKEN || true
          export OPENAI_API_KEY

          codex exec \
            --skip-git-repo-check \
            --full-auto \
            --model gpt-5.2-codex \
            "$(cat codex-request.md)"
      - name: Run lint
        run: |
          if [ -f package.json ]; then
            npm run lint --if-present
          fi

      - name: Run tests
        run: |
          if [ -f package.json ]; then
            npm test --if-present
          fi

      - name: Run build
        run: |
          if [ -f package.json ]; then
            npm run build --if-present
          fi

      - name: Create pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: "fix: address issue #${{ env.ISSUE_NUMBER }} via codex"
          title: "fix: codex resolves issue #${{ env.ISSUE_NUMBER }}"
          body: |
            ## Summary
            Automated Codex fix for issue #${{ env.ISSUE_NUMBER }}.

            - Source: `${{ env.REQUEST_SOURCE }}`
            - Requested by: @${{ env.REQUESTED_BY }}
            - Issue: ${{ env.ISSUE_URL }}

            ## Request
            ```text
            ${{ env.REQUEST_TEXT }}
            ```
          branch: ${{ steps.branch.outputs.branch }}
          base: main
          delete-branch: true

      - name: Comment result on issue
        if: always() && env.ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const issue_number = Number(process.env.ISSUE_NUMBER);
            const prUrl = `${{ steps.cpr.outputs.pull-request-url }}`;
            const prNumber = `${{ steps.cpr.outputs.pull-request-number }}`;
            const success = `${{ job.status }}` === 'success';

            let body;
            if (success && prUrl) {
              body = [
                '✅ Codex completed this request and opened a PR.',
                '',
                `- PR: #${prNumber} (${prUrl})`
              ].join('\n');
            } else if (success) {
              body = [
                'ℹ️ Codex run completed but no pull request was created.',
                'This usually means no file changes were necessary.'
              ].join('\n');
            } else {
              body = [
                '❌ Codex automation failed while attempting to implement this request.',
                '',
                `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              ].join('\n');
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });
