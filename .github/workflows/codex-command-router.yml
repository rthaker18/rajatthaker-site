name: Codex Command Router

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: read
  actions: write

jobs:
  route_issue_comment:
    # Only route commands from issue comments (not PR comments).
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request == null
    runs-on: ubuntu-latest

    steps:
      - name: Authorize single operator
        id: auth
        env:
          ASSOCIATION: ${{ github.event.comment.author_association }}
          COMMENTER: ${{ github.event.comment.user.login }}
          ALLOWED_OPERATOR: ${{ vars.ALLOWED_OPERATOR }}
        run: |
          trusted_association=false
          case "$ASSOCIATION" in
            OWNER|MEMBER|COLLABORATOR)
              trusted_association=true
              ;;
          esac

          if [ "$COMMENTER" = "$ALLOWED_OPERATOR" ] && [ "$trusted_association" = "true" ]; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
          else
            echo "authorized=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Parse command
        id: parse
        if: steps.auth.outputs.authorized == 'true'
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          if echo "$BODY" | grep -qE '^/deploy prod([[:space:]]|$)'; then
            echo "command=deploy_prod" >> "$GITHUB_OUTPUT"
          elif echo "$BODY" | grep -qE '^/change([[:space:]]|$)'; then
            echo "command=change" >> "$GITHUB_OUTPUT"

            # Remove the command token and trim whitespace so users can run:
            # /change <instruction>
            change_request="$(printf '%s' "$BODY" | sed -E '1s#^/change[[:space:]]*##')"
            {
              echo "request<<EOF"
              printf '%s\n' "$change_request"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "command=none" >> "$GITHUB_OUTPUT"
          fi

      - name: Handle /change
        if: steps.auth.outputs.authorized == 'true' && steps.parse.outputs.command == 'change'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const parsedRequest = `${{ toJson(steps.parse.outputs.request) }}`;
            const request = parsedRequest?.trim() || `${issue.title}\n\n${issue.body || ''}`;

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'codex_change_requested',
              client_payload: {
                source: 'issue_comment',
                issue_number: issue.number,
                issue_title: issue.title,
                issue_url: issue.html_url,
                comment_id: comment.id,
                comment_url: comment.html_url,
                requested_by: comment.user.login,
                request
              }
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                '✅ `/change` command accepted.',
                '',
                'I dispatched a `codex_change_requested` repository event with this issue context.',
                'Make sure a downstream workflow or automation listens for that event and performs the Codex fix flow.'
              ].join('\n')
            });

      - name: Handle /deploy prod
        if: steps.auth.outputs.authorized == 'true' && steps.parse.outputs.command == 'deploy_prod'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-prod.yml',
              ref: context.ref.replace('refs/heads/', ''),
              inputs: {
                source_ref: 'main'
              }
            });

      - name: Ignore unknown commands
        if: steps.auth.outputs.authorized == 'true' && steps.parse.outputs.command == 'none'
        run: echo "No recognized command"

      - name: Reject unauthorized commenter
        if: steps.auth.outputs.authorized == 'false'
        run: echo "Ignoring command from unauthorized commenter"

  route_issue_opened:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest

    steps:
      - name: Authorize single operator
        id: auth
        env:
          ASSOCIATION: ${{ github.event.issue.author_association }}
          AUTHOR: ${{ github.event.issue.user.login }}
          ALLOWED_OPERATOR: ${{ vars.ALLOWED_OPERATOR }}
        run: |
          trusted_association=false
          case "$ASSOCIATION" in
            OWNER|MEMBER|COLLABORATOR)
              trusted_association=true
              ;;
          esac

          if [ "$AUTHOR" = "$ALLOWED_OPERATOR" ] && [ "$trusted_association" = "true" ]; then
            echo "authorized=true" >> "$GITHUB_OUTPUT"
          else
            echo "authorized=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch change request for new issue
        if: steps.auth.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const issue = context.payload.issue;

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'codex_change_requested',
              client_payload: {
                source: 'issue_opened',
                issue_number: issue.number,
                issue_title: issue.title,
                issue_url: issue.html_url,
                requested_by: issue.user.login,
                request: `${issue.title}\n\n${issue.body || ''}`
              }
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                '✅ Issue received for Codex automation.',
                '',
                'I dispatched a `codex_change_requested` repository event using this issue title/body.'
              ].join('\n')
            });

      - name: Explain authorization requirement
        if: steps.auth.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                'ℹ️ This repo only auto-routes issues from the configured operator account.',
                '',
                'If you are the operator, verify `ALLOWED_OPERATOR` repository variable matches your GitHub username.'
              ].join('\n')
            });
